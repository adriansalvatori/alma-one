<?php

/**
 * 
 * This file is dynamically generated by the WordpressEnqueueChunksPlugin for Webpack.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
 * OR OTHER DEALINGS IN THE SOFTWARE.
 * 
 */

namespace WordpressEnqueueChunksPlugin;

class AssetRegistrationException extends \Exception {};

/**
 * Get a user-defined config setting
 *
 * @param string $key
 * @return mixed
 */
function get($key)
{
    static $config = null;
    if (defined('WPECP_TEST') && WPECP_TEST) {
        return WPECP_TEST_CONFIG[$key];
    }
    if (is_null($config)) {
        $config = json_decode('{"assetsDir":"build","context":"plugin","delimiter":"-","namespace":"cfw","phpScriptDir":"sources/php","manifest":{"chunks":{"cfw-grid":{"file":"css/cfw-grid.css","hash":"42e9b7680b84a1df5863a2c8fe4f7fbb"},"selectwoo-styles":{"file":"css/selectwoo-styles.css","hash":"4b8bfed0ba53c764726a2af458c9302b"},"selectwoo":{"file":"js/selectwoo-d97c1e220812d12a4a10.js","hash":"95c0716668cd5cdb399390d19a094e75"},"default-checkout-order-pay-thank-you-admin-plugins-side-cart":{"file":"js/default-checkout-order-pay-thank-you-admin-plugins-side-cart-3631574432032a11b196.js","hash":"e0d5bcd512fe1e88fef97a739712e600"},"default-checkout-order-pay-thank-you":{"file":"js/default-checkout-order-pay-thank-you-53f84a23cbc35577431a.js","hash":"bc9ea492db40872c0805ccd80dd73663"},"default-checkout-order-pay":{"file":"js/default-checkout-order-pay-4777d6a163834fa0a56b.js","hash":"4e02a8827c7395eb2a443bc3b683b283"},"default-checkout-side-cart":{"file":"js/default-checkout-side-cart-92936ce0bd45a69ce85c.js","hash":"012de61640448070df9fc549b9b94f86"},"checkout-styles":{"file":"css/checkout-styles.css","hash":"3aeb6283d7c0727cef2210bf607b4625"},"checkout":{"file":"js/checkout-e3c2eb88183d882ce754.js","hash":"1979e0ad82284b99b819e0cc04082192"},"order-pay-styles":{"file":"css/order-pay-styles.css","hash":"ed45ac67f52908abf2ea156068c3b023"},"order-pay":{"file":"js/order-pay-7371340ca9766434a0c0.js","hash":"fc07a98ba038b84484a70932ea3c83b7"},"thank-you-styles":{"file":"css/thank-you-styles.css","hash":"19abb655933d78802e69db9f90eab218"},"thank-you":{"file":"js/thank-you-e2bcddaf3fd91aaeeccb.js","hash":"9e20e8f132d100a2404a1dc0280fa9e1"},"admin-mce":{"file":"js/mce.js","hash":"7a70f5e26df473a661dbb88f9bb1a687"},"admin-styles":{"file":"css/admin-styles.css","hash":"e25e6a61a438886bd2e1b889321bfa3a"},"admin":{"file":"js/admin-d653af93e21ef61e9384.js","hash":"abdeca45a671cb79d3114058d7ba49f1"},"admin-acr-reports":{"file":"js/admin-acr-reports-f66238a648d030d55589.js","hash":"22ab6170a9809a95c8998cbfe2ca64a3"},"admin-settings":{"file":"js/admin-settings-63f6767534c6f8374322.js","hash":"1f9bfc4bd6426068ecf9bbdd246a3249"},"admin-plugins-styles":{"file":"css/admin-plugins-styles.css","hash":"2638d369f385bf56627600141ceef71d"},"admin-plugins":{"file":"js/admin-plugins-526a16da1aa9ce2b3343.js","hash":"92ff9438fa2bde6a99542c11a0fa4567"},"side-cart-styles":{"file":"css/side-cart-styles.css","hash":"2b8ba7f360f43aa9d9441bc90e29f5c1"},"side-cart":{"file":"js/side-cart-8342428d99e2592cfa1b.js","hash":"c2c04e9f65cd3b1a4f3349a15cdbb3ca"},"utils-script":{"file":"js/utils.js","hash":"2610cab2528fc99d64df86c6702f191b"}},"entries":{"cfw-grid":{"deps":[]},"selectwoo":{"deps":["selectwoo-styles"]},"checkout":{"deps":["default-checkout-order-pay-thank-you-admin-plugins-side-cart","default-checkout-order-pay-thank-you","default-checkout-order-pay","default-checkout-side-cart","checkout-styles"]},"order-pay":{"deps":["default-checkout-order-pay-thank-you-admin-plugins-side-cart","default-checkout-order-pay-thank-you","default-checkout-order-pay","order-pay-styles"]},"thank-you":{"deps":["default-checkout-order-pay-thank-you-admin-plugins-side-cart","default-checkout-order-pay-thank-you","thank-you-styles"]},"admin-mce":{"deps":[]},"admin":{"deps":["admin-styles"]},"admin-acr-reports":{"deps":[]},"admin-settings":{"deps":[]},"admin-plugins":{"deps":["default-checkout-order-pay-thank-you-admin-plugins-side-cart","admin-plugins-styles"]},"side-cart":{"deps":["default-checkout-order-pay-thank-you-admin-plugins-side-cart","default-checkout-side-cart","side-cart-styles"]},"utils-script":{"deps":[]}}},"prefix":"cfw-"}', true);
    }
    return isset($config[$key]) ? $config[$key] : null;
}

/**
 * Get an array of chunks and chunk meta from an array of script names
 * 
 * @param array $assets
 * @param array $manifest
 * @return array
 */
function getChunks(array $assets, array $manifest)
{
    if (empty($assets)) {
        return $manifest['chunks'];
    }
    $deps = array_reduce($assets, function($acc, $asset) use($manifest) {
        if (isset($manifest['entries'][$asset])) {
            return array_merge($acc, $manifest['entries'][$asset]['deps']);
        }
        return $acc;
    }, []);
    $keys = array_flip(array_unique(array_merge($assets, $deps)));
    return array_intersect_key($manifest['chunks'], $keys);
}

/**
 * Builds a script handle
 * 
 * @param string $asset
 * @return string
 */
function makeHandle($asset)
{
    $namespace = get('namespace');
    $delimiter = get('delimiter');
    return "{$namespace}{$delimiter}{$asset}";
}

/**
 * Check if a script has already been registered
 * 
 * @param string $asset
 * @return boolean
 */
function isRegistered($asset)
{
    return wp_script_is(makeHandle($asset), 'registered');
}

/**
 * Get the full url to an asset
 * 
 * @param string $file
 * @param string $context
 * @return string
 */
function getAssetUrl($file, $context)
{
    $dir = trailingslashit(get('assetsDir'));
    if ($context === 'plugin') {
        return plugins_url($dir . $file);
    }
    return get_theme_file_uri($dir . $file);
}

/**
 * Maps an asset's dependencies by handle
 * 
 * @param string $asset
 * @return array
 */
function mapDependencies($asset)
{
    $manifest = get('manifest');
    if (isset($manifest['entries'][$asset])) {
        $deps = $manifest['entries'][$asset]['deps'];
        return array_map(__NAMESPACE__ . '\\makeHandle', $deps);
    }
    return [];
}

/**
 * Generates arguments to be passed to wp_register_script
 * 
 * @param string $asset
 * @param array $data
 * @return array
 */
function makeScriptArgs($asset, array $data)
{
    $handle = makeHandle($asset);
    $src = getAssetUrl($data['file'], get('context'));
    $deps = mapDependencies($asset);
    $version = $data['hash'];
    $inFooter = true; // @TODO: expose this to the user
    return compact('handle', 'src', 'deps', 'version', 'inFooter');
}

/**
 * Register an asset
 * 
 * @param string $asset
 * @param array $args
 * @return boolean
 */
function register($asset, array $args)
{
    if (isRegistered($asset)) {
        return true;
    }
    $filtered = apply_filters("wpecp/register/$asset", $args);
    $success = call_user_func_array('wp_register_script', $filtered);
    if (!$success) {
        throw new AssetRegistrationException("Unable to register asset $asset!");
    }
    return true;
}

/**
 * Registers all or just some of the assets in a manifest
 * 
 * @param array $scripts
 * @return void
 */
function registerScripts(array $scripts = [])
{
    $manifest = get('manifest');
    foreach (getChunks($scripts, $manifest) as $chunk => $data) {
        if (isRegistered($chunk)) {
            continue;
        }
        $args = makeScriptArgs($chunk, $data);
        register($chunk, $args);
    }
}
